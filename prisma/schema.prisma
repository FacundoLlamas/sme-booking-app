// Prisma schema for SME Booking App
// PostgreSQL provider (Neon)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Customer {
  id                       Int                       @id @default(autoincrement())
  name                     String
  phone                    String                    @unique
  email                    String?
  address                  String?
  createdAt                DateTime                  @default(now()) @map("created_at")
  updatedAt                DateTime                  @updatedAt @map("updated_at")
  
  // Relations
  bookings                 Booking[]
  waitlist                 Waitlist[]
  conversations            Conversation[]
  notificationLogs         NotificationLog[]
  notificationPreferences  NotificationPreferences?
  remindersSent            ReminderSent[]
  
  @@map("customers")
}

model Service {
  id              Int      @id @default(autoincrement())
  name            String
  category        String
  durationMinutes Int      @map("duration_minutes")
  isEmergency     Boolean  @default(false) @map("is_emergency")
  createdAt       DateTime @default(now()) @map("created_at")
  
  // Relations
  bookings        Booking[]
  
  @@index([category])
  @@map("services")
}

model Business {
  id                    Int            @id @default(autoincrement())
  name                  String
  ownerEmail            String         @unique @map("owner_email")
  timezone              String         @default("UTC")
  maxConcurrentBookings Int            @default(5) @map("max_concurrent_bookings")
  createdAt             DateTime       @default(now()) @map("created_at")
  
  // Relations
  technicians           Technician[]
  bookings              Booking[]
  settings              Setting[]
  waitlist              Waitlist[]
  conversations         Conversation[]
  calendarCredentials   CalendarCredentials?
  
  @@map("businesses")
}

model Technician {
  id                 Int      @id @default(autoincrement())
  businessId         Int      @map("business_id")
  name               String
  skills             String?  // JSON or comma-separated
  availabilityStatus String   @default("available") @map("availability_status")
  createdAt          DateTime @default(now()) @map("created_at")
  
  // Relations
  business           Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  bookings           Booking[]
  
  @@index([businessId])
  @@index([availabilityStatus])
  @@map("technicians")
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  tableName String   @map("table_name")
  action    String
  recordId  Int      @map("record_id")
  changes   String?  // JSON string
  createdAt DateTime @default(now()) @map("created_at")
  
  @@index([tableName, recordId])
  @@map("audit_log")
}

model Setting {
  id         Int      @id @default(autoincrement())
  businessId Int      @map("business_id")
  key        String
  value      String?
  
  // Relations
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@unique([businessId, key])
  @@index([businessId])
  @@map("settings")
}

model Waitlist {
  id          Int      @id @default(autoincrement())
  customerId  Int      @map("customer_id")
  businessId  Int      @map("business_id")
  serviceType String   @map("service_type")
  position    Int      @default(1)
  notes       String?
  createdAt   DateTime @default(now()) @map("created_at")
  
  // Relations
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@index([customerId])
  @@index([businessId])
  @@index([createdAt])
  @@map("waitlist")
}

model Conversation {
  id            Int       @id @default(autoincrement())
  customerId    Int?      @map("customer_id")
  sessionId     String    @unique @map("session_id")
  businessId    Int?      @map("business_id")
  status        String    @default("active")
  context       String?   // JSON string storing conversation context
  classification String?  // Last classification result (JSON)
  expiresAt     DateTime? @map("expires_at") // Session expiry for cleanup (7-day default)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  // Relations
  customer      Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  business      Business? @relation(fields: [businessId], references: [id], onDelete: SetNull)
  messages      Message[]
  
  @@index([sessionId])
  @@index([customerId])
  @@index([businessId])
  @@index([expiresAt])
  @@index([createdAt])
  @@map("conversations")
}

model Message {
  id             Int        @id @default(autoincrement())
  conversationId Int        @map("conversation_id")
  role           String     // "user" or "assistant"
  content        String
  classification String?    // JSON: { service_type, urgency, confidence, next_steps }
  tokens         Int?
  createdAt      DateTime   @default(now()) @map("created_at")
  
  // Relations
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@index([conversationId])
  @@index([role])
  @@index([createdAt])
  @@map("messages")
}

model NotificationLog {
  id            Int      @id @default(autoincrement())
  bookingId     Int      @map("booking_id")
  customerId    Int      @map("customer_id")
  type          String   // "sms" or "email"
  recipientAddr String   @map("recipient_addr") // phone or email address
  subject       String?  // email subject or SMS title
  body          String
  status        String   @default("sent") // "sent", "queued", "failed", "bounced"
  externalId    String?  @map("external_id") // Twilio SID, SendGrid message ID, etc.
  errorMessage  String?  @map("error_message")
  retryCount    Int      @default(0) @map("retry_count")
  lastRetryAt   DateTime? @map("last_retry_at")
  sentAt        DateTime? @map("sent_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // Relations
  booking       Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  customer      Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  @@index([bookingId])
  @@index([customerId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@map("notification_log")
}

model NotificationPreferences {
  id           Int     @id @default(autoincrement())
  customerId   Int     @unique @map("customer_id")
  smsEnabled   Boolean @default(true) @map("sms_enabled")
  emailEnabled Boolean @default(true) @map("email_enabled")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  
  // Relations
  customer     Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  @@index([customerId])
  @@map("notification_preferences")
}

model ReminderSent {
  id            Int      @id @default(autoincrement())
  bookingId     Int      @map("booking_id")
  customerId    Int      @map("customer_id")
  reminderType  String   @map("reminder_type") // "24h" or "2h"
  channel       String   // "sms" or "email"
  sentAt        DateTime @default(now()) @map("sent_at")
  createdAt     DateTime @default(now()) @map("created_at")
  
  // Relations
  booking       Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  customer      Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  @@unique([bookingId, reminderType, channel])
  @@index([bookingId])
  @@index([customerId])
  @@index([reminderType])
  @@index([sentAt])
  @@map("reminders_sent")
}

model ClassificationMetric {
  id                       Int     @id @default(autoincrement())
  serviceType              String  @map("service_type")
  urgency                  String
  confidence               Float
  estimatedDurationMinutes Int     @map("estimated_duration_minutes")
  latencyMs                Int     @map("latency_ms")
  tokensUsed               Int     @map("tokens_used")
  costUsd                  Float   @map("cost_usd")
  fromCache                Boolean @default(false) @map("from_cache")
  fromFallback             Boolean @default(false) @map("from_fallback")
  modelUsed                String  @map("model_used")
  success                  Boolean @default(true)
  errorCode                String? @map("error_code")
  timestamp                DateTime @default(now())
  createdAt                DateTime @default(now()) @map("created_at")
  
  @@index([serviceType])
  @@index([timestamp])
  @@index([success])
  @@index([fromCache])
  @@index([fromFallback])
  @@index([createdAt])
  @@map("classification_metrics")
}

// ==================== GOOGLE CALENDAR INTEGRATION ====================

model CalendarCredentials {
  id           Int      @id @default(autoincrement())
  businessId   Int      @unique @map("business_id")
  accessToken  String?  @map("access_token")
  refreshToken String?  @map("refresh_token")
  expiresAt    DateTime? @map("expires_at")
  scopes       String?  // JSON array of OAuth scopes
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  
  // Relations
  business     Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@index([businessId])
  @@index([expiresAt])
  @@map("calendar_credentials")
}

model CalendarSyncLog {
  id           Int      @id @default(autoincrement())
  businessId   Int      @map("business_id")
  eventId      String?  @map("event_id")     // Google Calendar event ID
  bookingId    Int?     @map("booking_id")   // Link to our booking
  action       String   // 'created', 'updated', 'deleted', 'conflict_detected'
  status       String   @default("synced")   // 'synced', 'failed', 'conflict', 'manual_intervention'
  details      String?  // JSON: { conflict_info, error_message, etc. }
  createdAt    DateTime @default(now()) @map("created_at")
  
  // Relations
  booking      Booking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  
  @@index([businessId])
  @@index([eventId])
  @@index([bookingId])
  @@index([action])
  @@index([status])
  @@index([createdAt])
  @@map("calendar_sync_log")
}

// Add relation to Booking model for sync logs
model Booking {
  id           Int         @id @default(autoincrement())
  customerId   Int         @map("customer_id")
  businessId   Int         @map("business_id")
  serviceId    Int         @map("service_id")
  serviceType  String?     @map("service_type")  // Optional denormalized cache
  technicianId Int?        @map("technician_id")
  bookingTime  DateTime    @map("booking_time")
  confirmationCode String?  @unique @map("confirmation_code") // 8 alphanumeric code
  status       String      @default("pending")
  notes        String?
  calendarEventId String?  @map("calendar_event_id")  // Google Calendar event ID
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")
  
  // Relations
  customer     Customer    @relation(fields: [customerId], references: [id], onDelete: Cascade)
  business     Business    @relation(fields: [businessId], references: [id], onDelete: Cascade)
  service      Service     @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  technician   Technician? @relation(fields: [technicianId], references: [id], onDelete: SetNull)
  syncLogs     CalendarSyncLog[]
  notificationLogs NotificationLog[]
  remindersSent ReminderSent[]
  
  @@index([customerId])
  @@index([businessId])
  @@index([serviceId])
  @@index([technicianId])
  @@index([status])
  @@index([bookingTime])
  @@index([status, bookingTime])
  @@index([calendarEventId])
  @@map("bookings")
}
